<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="color-scheme" content="light dark"/>
    <link rel="stylesheet" href="css/pico.min.css"/>
    <link rel="stylesheet" href="css/pico.colors.min.css"/>
    <link rel="stylesheet" href="styles.css">
    <title>Property Search</title>
</head>
<body>
<main class="container">
    <h1>Property Search</h1>
    <form id="searchForm">
        <fieldset>
            Price, €/mo
            <div class="grid">
                <input name="min_price" type="number" placeholder="Min" autocomplete="min_price"/>
                <input name="max_price" type="number" placeholder="Max" autocomplete="max_price"/>
            </div>

            Size, m²
            <div class="grid">
                <input name="min_size" type="number" placeholder="Min" autocomplete="min_size"/>
                <input name="max_size" type="number" placeholder="Max" autocomplete="max_size"/>
            </div>

            Rooms
            <div class="grid">
                <input name="min_rooms" type="number" placeholder="Min" autocomplete="min_rooms"/>
                <input name="max_rooms" type="number" placeholder="Max" autocomplete="max_rooms"/>
            </div>

            Year of construction
            <div class="grid">
                <input name="min_year" type="number" placeholder="Min" autocomplete="min_year"/>
                <input name="max_year" type="number" placeholder="Max" autocomplete="max_year"/>
            </div>

            <label for="energy_label">Worst energy label</label>
            <select id="energy_label" name="energy_label" autocomplete="energy_label">
                <option value="">Any</option>
                <option value="A+++++">A+++++</option>
                <option value="A++++">A++++</option>
                <option value="A+++">A+++</option>
                <option value="A++">A++</option>
                <option value="A+">A+</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
            </select>

            <label>Location</label>
            <label>
                Radius: <span id="radius_text">1000</span> m
                <input type="range" name="radius" min="100" max="5000" step="100" value="1000"
                       onchange="updateRange(this.value)">
            </label>
            <div id="map"></div>
            <div class="grid">
                <input type="button" value="Confirm position" class="accent"
                       onclick="confirmPosition()"/>
                <input type="button" value="Clear position" onclick="clearPosition()"/>
            </div>
            <div id="locationView" class="grid hidden">
                <label>Latitude
                    <input type="text" id="latitude" name="latitude" placeholder="Latitude" disabled>
                </label>
                <label>Longitude
                    <input type="text" id="longitude" name="longitude" placeholder="Longitude" disabled>
                </label>
            </div>

        </fieldset>
        <input type="button" value="Done" onclick="submitForm(this)"/>
    </form>
</main>

<!-- Load the Google Maps JavaScript API -->
<script>
    (g => {
        var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__",
            m = document, b = window;
        b = b[c] || (b[c] = {});
        var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
            u = () => h || (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                d[q] = f;
                a.onerror = () => h = n(Error(p + " could not load."));
                a.nonce = m.querySelector("script[nonce]")?.nonce || "";
                m.head.append(a)
            }));
        d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
    })({
        key: "AIzaSyDet83PtDogCpB4PSoZhuHYlEF7JXW38dw",
        v: "weekly",
        // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
        // Add other bootstrap parameters as needed, using camel case.
    });
</script>
<!-- Load the Telegram Web App JS SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
    let map, pin, circle;
    let radiusText = document.getElementById("radius_text");

    async function initMap() {
        const {Map} = await google.maps.importLibrary("maps");
        const {AdvancedMarkerElement} = await google.maps.importLibrary("marker");

        let amsterdam = {lat: 52.37281, lng: 4.89370};
        map = new Map(document.getElementById("map"), {
            center: amsterdam,
            zoom: 14,
            mapId: "9ca8c43502ecd2ce",
        });

        pin = new AdvancedMarkerElement({
            map,
            position: amsterdam,
            draggable: true,
        });

        circle = new google.maps.Circle({
            map,
            center: amsterdam,
            radius: 1000,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            strokeWeight: 1,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
        });

        // marker stays in the center of the map
        map.addListener("center_changed", () => {
            pin.position = map.center;
            circle.setCenter(map.center);
        });
    }

    function updateRange(value) {
        circle.setRadius(parseInt(value));
        radiusText.innerHTML = value;
    }

    function confirmPosition() {
        document.getElementById("latitude").value = pin.position.lat + "°";
        document.getElementById("longitude").value = pin.position.lng + "°";
        document.getElementById("locationView").classList.remove("hidden");
    }

    function clearPosition() {
        document.getElementById("latitude").value = "";
        document.getElementById("longitude").value = "";
        document.getElementById("locationView").classList.add("hidden");
    }

    // send all form fields as JSON to the Telegram app
    function submitForm() {
        let data = {};
        let form = document.getElementById("searchForm");
        for (let i = 0; i < form.length; i++) {
            if (form.elements[i].name) {
                data[form.elements[i].name] = form.elements[i].value;
            }
        }
        console.log(data);
        Telegram.WebApp.sendData(JSON.stringify(data));
    }

    initMap();
    Telegram.WebApp.ready();
</script>

</body>
</html>
